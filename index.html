<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator de Faturas de Energia</title>
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca pdf.js para ler arquivos PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <!-- Biblioteca SheetJS (xlsx) para gerar arquivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Estilos personalizados para a área de arrastar e soltar e para o loader */
        #drop-zone {
            border: 2px dashed #ccc;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: border-color 0.3s, background-color 0.3s;
        }
        #drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-5xl mx-auto">
            
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Extrator de Faturas de Energia</h1>
                <p class="text-gray-500 mt-2">Envie as suas faturas em PDF para extrair e exportar os dados.</p>
            </header>

            <!-- Área de Upload -->
            <div id="drop-zone" class="mb-6">
                <div class="flex flex-col items-center justify-center">
                     <i data-lucide="upload-cloud" class="w-16 h-16 text-gray-400 mb-4"></i>
                    <p class="text-gray-600">Arraste e solte os ficheiros PDF aqui</p>
                    <p class="text-gray-500 text-sm my-2">ou</p>
                    <label for="pdf-upload" class="cursor-pointer bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                        Selecione os Ficheiros
                    </label>
                    <input type="file" id="pdf-upload" multiple accept=".pdf" class="hidden">
                </div>
            </div>
            
             <!-- Feedback para o utilizador -->
            <div id="status" class="text-center text-sm text-gray-600 mb-6 min-h-[20px]"></div>
            <div id="loader" class="hidden mx-auto loader mb-6"></div>


            <!-- Tabela de Dados Extraídos -->
            <div class="mb-6">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Dados Extraídos</h2>
                    <div class="flex gap-2">
                         <button id="clear-data" class="bg-red-500 text-white px-5 py-2 rounded-lg font-semibold hover:bg-red-600 transition-colors flex items-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                            Limpar Dados
                        </button>
                        <button id="export-excel" class="bg-green-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            <i data-lucide="file-spreadsheet" class="w-5 h-5"></i>
                            Exportar para Excel
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="min-w-full bg-white text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-left font-semibold text-gray-600">Unidade Consumidora</th>
                                <th class="p-3 text-left font-semibold text-gray-600">Instalação</th>
                                <th class="p-3 text-left font-semibold text-gray-600">Conta Mês</th>
                                <th class="p-3 text-right font-semibold text-gray-600">Qtd. Faturada (kWh)</th>
                                <th class="p-3 text-right font-semibold text-gray-600">Valor IRRF (R$)</th>
                                <th class="p-3 text-right font-semibold text-gray-600">Total a Pagar (R$)</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body">
                           <!-- Linhas de dados serão inseridas aqui via JavaScript -->
                           <tr id="placeholder-row">
                               <td colspan="6" class="p-4 text-center text-gray-500">Nenhum dado extraído ainda. Envie um ficheiro PDF para começar.</td>
                           </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Lógica da Aplicação -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('pdf-upload');
            const statusDiv = document.getElementById('status');
            const loader = document.getElementById('loader');
            const exportButton = document.getElementById('export-excel');
            const clearButton = document.getElementById('clear-data');
            const dataTableBody = document.getElementById('data-table-body');

            let localData = [];

            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

            // --- Funções da Interface ---
            const setupDragAndDrop = () => {
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
                dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
                });
                fileInput.addEventListener('change', () => {
                    if (fileInput.files.length > 0) handleFiles(fileInput.files);
                });
            };

            const renderTable = () => {
                localData.sort((a, b) => a.nomeUnidade.localeCompare(b.nomeUnidade));
                if (localData.length > 0) {
                    dataTableBody.innerHTML = localData.map(createTableRow).join('');
                    exportButton.disabled = false;
                    clearButton.disabled = false;
                } else {
                    dataTableBody.innerHTML = `<tr id="placeholder-row"><td colspan="6" class="p-4 text-center text-gray-500">Nenhum dado extraído ainda. Envie um ficheiro PDF para começar.</td></tr>`;
                    exportButton.disabled = true;
                    clearButton.disabled = true;
                }
            };

            const createTableRow = (data) => {
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3">${data.nomeUnidade}</td>
                        <td class="p-3">${data.instalacao}</td>
                        <td class="p-3">${data.contaMes}</td>
                        <td class="p-3 text-right">${(data.qtdFaturada || 0).toLocaleString('pt-BR')}</td>
                        <td class="p-3 text-right">${(data.valorIRRF || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                        <td class="p-3 text-right font-semibold text-gray-800">${(data.totalPagar || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    </tr>
                `;
            };

            // --- Funções de Processamento de Ficheiros ---
            const handleFiles = async (files) => {
                loader.style.display = 'block';
                statusDiv.textContent = 'Iniciando processamento...';
                let filesProcessed = 0;
                
                for (const file of files) {
                    filesProcessed++;
                    if (file.type !== 'application/pdf') {
                        statusDiv.textContent = `Ficheiro '${file.name}' não é um PDF. A ignorar...`;
                        continue;
                    }
                    
                    statusDiv.textContent = `A processar o ficheiro ${filesProcessed} de ${files.length}: ${file.name}...`;
                    try {
                        const extractedItems = await processPdf(file);
                        localData.push(...extractedItems);
                    } catch (error) {
                         console.error(`Erro ao processar ${file.name}:`, error);
                         statusDiv.textContent = `Ocorreu um erro ao processar o ficheiro ${file.name}.`;
                    }
                }

                renderTable();
                loader.style.display = 'none';
                statusDiv.textContent = 'Processamento concluído.';
            };

            const processPdf = (file) => {
                return new Promise((resolve, reject) => {
                    const fileReader = new FileReader();
                    fileReader.onload = async function() {
                        try {
                            const typedarray = new Uint8Array(this.result);
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            const allPagesData = [];

                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                // We join with spaces to handle cases where a single value is split into multiple items
                                const pageText = textContent.items.map(item => item.str).join(' '); 
                                
                                const extractedData = extractDataFromText(pageText);
                                
                                if (extractedData) {
                                    console.log(`Dados extraídos da página ${i}:`, extractedData);
                                    allPagesData.push(extractedData);
                                } else {
                                    console.warn(`Nenhum dado válido extraído da página ${i} do ficheiro ${file.name}.`);
                                }
                            }
                            resolve(allPagesData);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    fileReader.onerror = () => reject(new Error('Erro ao ler o ficheiro.'));
                    fileReader.readAsArrayBuffer(file);
                });
            };
            
            const extractDataFromText = (text) => {
                const cleanNumber = (str) => {
                    if (!str || typeof str !== 'string') return 0;
                    return parseFloat(str.replace(/\./g, '').replace(',', '.'));
                };

                const data = {
                    nomeUnidade: null,
                    instalacao: null,
                    contaMes: null,
                    totalPagar: null,
                    valorIRRF: null,
                    qtdFaturada: null
                };

                // 1. NOME DA UNIDADE CONSUMIDORA (Ponto de partida)
                let match = text.match(/DADOS\s+DA\s+UNIDADE\s+CONSUMIDORA\s+([A-Z\s\d]+)/i);
                if (match && match[1]) {
                    // Remove address details that might follow
                    data.nomeUnidade = match[1].trim().split(/\s{2,}/)[0]; 
                }
                if (!data.nomeUnidade || data.nomeUnidade.length < 5) {
                    console.error("Não foi possível extrair o nome da Unidade Consumidora. A fatura será ignorada.");
                    return null;
                }

                // 2. TOTAL A PAGAR (essencial)
                match = text.match(/TOTAL\s+A\s+PAGAR\s*([\d\.,]+)/i);
                if (match) data.totalPagar = match[1];
                else {
                    match = text.match(/Total\s+Consolidado\s*([\d\.,]+)/i);
                    if (match) data.totalPagar = match[1];
                }

                // 3. INSTALAÇÃO (essencial)
                match = text.match(/INSTALAÇÃO\s*(\d[\d\s]*\d)/i);
                if (match) data.instalacao = match[1].replace(/\s/g, '');

                // 4. CONTA MÊS
                match = text.match(/CONTA\s+MÊS\s*([A-Z]{3}\/\d{4})/i);
                if (match) data.contaMes = match[1];

                // 5. VALOR IRRF
                match = text.match(/Retenção\s+Consumo\s+IRRF.*?([\d\.,]+)/i);
                if (match) data.valorIRRF = match[1];
                
                // 6. QUANTIDADE FATURADA
                match = text.match(/(?:Consumo Uso Sistema|Custo Disp Uso Sistema)\s+\(KWH-TUSD.*?\s+([A-Z]{3}\/\d{2,})\s+([\d\.,]+)/i);
                if (match) data.qtdFaturada = match[2];

                // VALIDAÇÃO FINAL
                if (!data.instalacao || !data.totalPagar) {
                    console.warn("Dados essenciais (Instalação ou Total a Pagar) não encontrados para:", data.nomeUnidade);
                    return null;
                }

                return {
                    nomeUnidade: data.nomeUnidade.trim(),
                    instalacao: data.instalacao,
                    contaMes: data.contaMes || 'Não encontrado',
                    totalPagar: cleanNumber(data.totalPagar),
                    valorIRRF: cleanNumber(data.valorIRRF),
                    qtdFaturada: cleanNumber(data.qtdFaturada)
                };
            };
            
            // --- Funções dos Botões ---
            const clearAllData = () => {
                localData = [];
                renderTable();
                statusDiv.textContent = 'Dados limpos.';
            };

            const exportToExcel = () => {
                if (localData.length === 0) {
                    alert('Não há dados para exportar.');
                    return;
                }
                const dataToExport = localData.map(item => ({
                    'Unidade Consumidora': item.nomeUnidade,
                    'Instalação': item.instalacao,
                    'Conta Mês': item.contaMes,
                    'Quantidade Faturada (kWh)': item.qtdFaturada,
                    'Valor IRRF (R$)': item.valorIRRF,
                    'Total a Pagar (R$)': item.totalPagar
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Faturas');
                XLSX.writeFile(workbook, 'dados_faturas.xlsx');
            };

            exportButton.addEventListener('click', exportToExcel);
            clearButton.addEventListener('click', clearAllData);
            
            // --- Inicialização ---
            setupDragAndDrop();
            lucide.createIcons();
        });
    </script>
</body>
</html>